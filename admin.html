const URL_API = 'https://script.google.com/macros/s/AKfycby-rnmBcploCmdEb8QWkMyo1tEanCcPkmNOA_QMlujH0XQvjLeiCCYhkqe7Hqhi6-mo8A/exec';

const CAMPOS_PADRAO = [
    { key: 'NomeCompleto', label: 'Nome Completo' },
    { key: 'DataNascimento', label: 'Data de Nascimento' },
    { key: 'Telefone', label: 'Celular (WhatsApp)' },
    { key: 'Endereco', label: 'Endereço Completo' },
    { key: 'NomeInstituicao', label: 'Nome da Instituição' },
    { key: 'NomeCurso', label: 'Nome do Curso' },
    { key: 'PeriodoCurso', label: 'Período/Semestre' },
    { key: 'Matricula', label: 'Nº Matrícula' }
];

let mapaEventos = {}; 
// Instâncias dos gráficos para poder atualizar depois
let chartEventosInstance = null;
let chartStatusInstance = null;

// --- Login e Inicialização ---
function realizarLogin(e) {
    e.preventDefault();
    const pass = document.getElementById('admin-pass').value;
    fetch(URL_API, { method: 'POST', body: JSON.stringify({ action: 'loginAdmin', senha: pass }) }).then(res=>res.json()).then(json=>{
        if(json.auth){
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            sessionStorage.setItem('admin_token', pass);
            // Carrega Dashboard ao entrar
            carregarDashboard();
        } else Swal.fire('Erro', 'Senha incorreta', 'error');
    });
}

function logout() { sessionStorage.removeItem('admin_token'); location.reload(); }

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
    
    document.getElementById(tabId).classList.remove('hidden');
    document.getElementById(tabId).classList.add('active');
    if(event && event.currentTarget) event.currentTarget.classList.add('active');

    if(tabId === 'tab-dashboard') carregarDashboard();
    if(tabId === 'tab-inscricoes') carregarInscricoes();
    if(tabId === 'tab-config') carregarInstituicoes();
}

// --- DASHBOARD E GRÁFICOS ---
function carregarDashboard() {
    const token = sessionStorage.getItem('admin_token');
    
    // Carrega Eventos e Inscrições em paralelo
    Promise.all([
        fetch(`${URL_API}?action=getTodosEventos`).then(r => r.json()),
        fetch(`${URL_API}?action=getInscricoesAdmin&token=${token}`).then(r => r.json())
    ]).then(([jsonEventos, jsonInscricoes]) => {
        
        // Popula mapa de eventos
        mapaEventos = {};
        jsonEventos.data.forEach(ev => mapaEventos[ev.id] = ev.titulo);
        
        // Atualiza Selects de Relatório
        atualizarSelectsRelatorio(jsonEventos.data, jsonInscricoes.data);

        // --- CARDS ---
        const total = jsonInscricoes.data.length;
        const aprovados = jsonInscricoes.data.filter(i => i.status.includes('Aprovada') || i.status.includes('Emitida')).length;
        const pendentes = jsonInscricoes.data.filter(i => i.status === 'Pendente').length;

        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-aprovados').innerText = aprovados;
        document.getElementById('stat-pendentes').innerText = pendentes;

        // --- DADOS PARA GRÁFICOS ---
        
        // 1. Inscrições por Evento
        const contagemEventos = {};
        jsonInscricoes.data.forEach(i => {
            const nome = mapaEventos[i.eventoId] || 'Outros';
            contagemEventos[nome] = (contagemEventos[nome] || 0) + 1;
        });

        // 2. Status
        const contagemStatus = {};
        jsonInscricoes.data.forEach(i => {
            contagemStatus[i.status] = (contagemStatus[i.status] || 0) + 1;
        });

        renderizarGraficos(contagemEventos, contagemStatus);
    });
}

function renderizarGraficos(dadosEventos, dadosStatus) {
    // Gráfico de Barras (Eventos)
    const ctx1 = document.getElementById('chartEventos').getContext('2d');
    if(chartEventosInstance) chartEventosInstance.destroy(); // Limpa anterior
    chartEventosInstance = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: Object.keys(dadosEventos),
            datasets: [{
                label: 'Inscritos',
                data: Object.values(dadosEventos),
                backgroundColor: '#3b82f6',
                borderRadius: 5
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Gráfico de Rosca (Status)
    const ctx2 = document.getElementById('chartStatus').getContext('2d');
    if(chartStatusInstance) chartStatusInstance.destroy();
    chartStatusInstance = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: Object.keys(dadosStatus),
            datasets: [{
                data: Object.values(dadosStatus),
                backgroundColor: ['#f59e0b', '#10b981', '#ef4444', '#3b82f6']
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// --- RELATÓRIOS (MOTORISTAS) ---

function atualizarSelectsRelatorio(eventos, inscricoes) {
    const selEvento = document.getElementById('relatorio-evento');
    const selInst = document.getElementById('relatorio-inst');
    
    // Popula Eventos
    selEvento.innerHTML = '<option value="">Selecione o Evento...</option>';
    eventos.forEach(ev => {
        selEvento.innerHTML += `<option value="${ev.id}">${ev.titulo}</option>`;
    });

    // Popula Instituições (Extrai dos dados salvos no JSON das inscrições)
    let instituicoes = new Set();
    inscricoes.forEach(ins => {
        try {
            const dados = JSON.parse(ins.dadosJson);
            if(dados.NomeInstituicao) instituicoes.add(dados.NomeInstituicao);
        } catch(e){}
    });
    
    selInst.innerHTML = '<option value="">Todas as Instituições</option>';
    instituicoes.forEach(inst => {
        selInst.innerHTML += `<option value="${inst}">${inst}</option>`;
    });
}

function gerarRelatorioTransporte() {
    const eventoId = document.getElementById('relatorio-evento').value;
    const instFiltro = document.getElementById('relatorio-inst').value;
    
    if(!eventoId) return Swal.fire('Atenção', 'Selecione um evento para gerar a lista.', 'warning');

    Swal.fire({ title: 'Gerando...', didOpen: () => Swal.showLoading() });

    // Busca dados novamente para garantir atualização (poderia usar cache, mas segurança primeiro)
    const token = sessionStorage.getItem('admin_token');
    fetch(`${URL_API}?action=getInscricoesAdmin&token=${token}`)
        .then(res => res.json())
        .then(json => {
            const nomeEvento = mapaEventos[eventoId] || 'Evento';
            
            // Filtra os alunos
            const alunosFiltrados = json.data.filter(i => {
                let dados = {}; try{dados=JSON.parse(i.dadosJson)}catch(e){}
                const matchEvento = String(i.eventoId) === String(eventoId);
                const matchInst = instFiltro === "" || dados.NomeInstituicao === instFiltro;
                const matchStatus = i.status === 'Aprovada' || i.status === 'Ficha Emitida'; // Só aprovados viajam
                return matchEvento && matchInst && matchStatus;
            });

            if(alunosFiltrados.length === 0) {
                Swal.fire('Vazio', 'Nenhum aluno APROVADO encontrado com esses filtros.', 'info');
                return;
            }

            // Monta HTML para impressão
            let linhas = '';
            alunosFiltrados.forEach((aluno, index) => {
                let d = JSON.parse(aluno.dadosJson);
                linhas += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${d.NomeCompleto}</td>
                        <td>${d.NomeInstituicao || '-'}</td>
                        <td>${d.Endereco || '-'}</td>
                        <td>${d.Bairro || '-'}</td>
                    </tr>
                `;
            });

            const htmlImpressao = `
                <div class="print-header">
                    <h2>Rota de Transporte Escolar</h2>
                    <p><strong>Evento:</strong> ${nomeEvento}</p>
                    <p><strong>Instituição:</strong> ${instFiltro || 'Todas'}</p>
                    <p><strong>Total de Alunos:</strong> ${alunosFiltrados.length}</p>
                </div>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th style="width:30px">#</th>
                            <th>Nome do Aluno</th>
                            <th>Instituição</th>
                            <th>Endereço</th>
                            <th>Bairro</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhas}
                    </tbody>
                </table>
                <div style="margin-top:30px; border-top:1px solid #000; padding-top:10px; display:flex; justify-content:space-between;">
                    <span>Motorista: ____________________________</span>
                    <span>Data: ____/____/_______</span>
                </div>
            `;

            document.getElementById('area-impressao').innerHTML = htmlImpressao;
            Swal.close();
            
            // Aciona impressão do navegador
            setTimeout(() => window.print(), 500);
        });
}

// ... (Restante das funções padrão: addInstituicao, carregarInscricoes, etc. mantidas iguais) ...
// Certifique-se de manter as funções carregarInstituicoes, addInstituicao, removerInst, modalNovoEvento, etc. 
// Para economizar espaço, não repeti aqui as funções que não mudaram da versão v7.0 anterior, 
// mas elas DEVEM estar presentes no arquivo final. Se precisar delas novamente, avise.

function carregarInstituicoes(){const d=document.getElementById('lista-instituicoes');d.innerHTML='<p>...</p>';fetch(`${URL_API}?action=getInstituicoes`).then(r=>r.json()).then(j=>{d.innerHTML='';if(!j.data.length){d.innerHTML='<p>Vazio</p>';return}j.data.forEach(n=>{d.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee"><span>${n}</span><button onclick="removerInst('${n}')" style="color:red;border:none;background:none;cursor:pointer"><i class="fa-solid fa-trash"></i></button></div>`})})}
function addInstituicao(){const n=document.getElementById('nova-inst').value;if(!n)return;fetch(URL_API,{method:'POST',body:JSON.stringify({action:'adicionarInstituicao',nome:n,senha:sessionStorage.getItem('admin_token')})}).then(()=>{document.getElementById('nova-inst').value='';carregarInstituicoes()})}
function removerInst(n){if(confirm('Remover?'))fetch(URL_API,{method:'POST',body:JSON.stringify({action:'removerInstituicao',nome:n,senha:sessionStorage.getItem('admin_token')})}).then(()=>carregarInstituicoes())}
function carregarEventosAdmin(){fetch(`${URL_API}?action=getTodosEventos`).then(r=>r.json()).then(j=>{const t=document.getElementById('lista-eventos-admin');t.innerHTML='';mapaEventos={};j.data.sort((a,b)=>b.id-a.id).forEach(ev=>{mapaEventos[ev.id]=ev.titulo;let btn=ev.status==='Ativo'?`<button class="action-btn btn-status-toggle active" onclick="toggleStatus('${ev.id}','Inativo')">Inativar</button>`:`<button class="action-btn btn-status-toggle inactive" onclick="toggleStatus('${ev.id}','Ativo')">Ativar</button>`;t.innerHTML+=`<tr><td>${ev.id}</td><td>${ev.titulo}</td><td><span class="badge badge-${ev.status}">${ev.status}</span></td><td>${btn}</td></tr>`})})}
function toggleStatus(id,st){fetch(URL_API,{method:'POST',body:JSON.stringify({action:'alterarStatusEvento',senha:sessionStorage.getItem('admin_token'),id:id,novoStatus:st})}).then(()=>carregarEventosAdmin())}
function modalNovoEvento() { /* Código do modal já enviado na versão anterior */ let htmlCampos = '<div class="checkbox-grid">'; CAMPOS_PADRAO.forEach(c => { htmlCampos += `<div class="checkbox-item"><input type="checkbox" id="check_${c.key}" value="${c.key}" checked><label for="check_${c.key}">${c.label}</label></div>`; }); htmlCampos += '</div>'; Swal.fire({ title: 'Criar Evento', width: '800px', html: `<input id="swal-titulo" class="swal2-input" placeholder="Título"><input id="swal-desc" class="swal2-input" placeholder="Descrição"><div style="display:flex;gap:10px"><input type="date" id="swal-inicio" class="swal2-input"><input type="date" id="swal-fim" class="swal2-input"></div>${htmlCampos}`, preConfirm: () => { const sels=[]; CAMPOS_PADRAO.forEach(c=>{if(document.getElementById(`check_${c.key}`).checked) sels.push(c.key)}); return {titulo:document.getElementById('swal-titulo').value, descricao:document.getElementById('swal-desc').value, inicio:document.getElementById('swal-inicio').value, fim:document.getElementById('swal-fim').value, config:JSON.stringify({camposTexto:sels, arquivos:{foto:true,doc:true}}), status:'Ativo'} } }).then(r=>{if(r.isConfirmed){fetch(URL_API,{method:'POST',body:JSON.stringify({action:'criarEvento',senha:sessionStorage.getItem('admin_token'),dados:r.value})}).then(()=>carregarEventosAdmin())}})}
function carregarInscricoes(){const t=sessionStorage.getItem('admin_token');fetch(`${URL_API}?action=getInscricoesAdmin&token=${t}`).then(r=>r.json()).then(j=>{window.inscricoesData=j.data;const tb=document.getElementById('lista-inscricoes-admin');tb.innerHTML='';j.data.forEach(i=>{let d={};try{d=JSON.parse(i.dadosJson)}catch(e){}tb.innerHTML+=`<tr><td>${new Date(i.data).toLocaleDateString()}</td><td>${mapaEventos[i.eventoId]}</td><td>${d.NomeCompleto}</td><td>${i.status}</td><td>--</td></tr>`})})}
function filtrarTabela(){/*Lógica filtro*/}
